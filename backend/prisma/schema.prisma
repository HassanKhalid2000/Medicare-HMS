// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  admin
  doctor
  nurse
  receptionist
}

enum UserStatus {
  active
  inactive
  suspended
}

enum Gender {
  male
  female
  other
}

enum PatientStatus {
  active
  inactive
  discharged
}

enum BloodGroup {
  A_POSITIVE  @map("A+")
  A_NEGATIVE  @map("A-")
  B_POSITIVE  @map("B+")
  B_NEGATIVE  @map("B-")
  AB_POSITIVE @map("AB+")
  AB_NEGATIVE @map("AB-")
  O_POSITIVE  @map("O+")
  O_NEGATIVE  @map("O-")
}

enum Specialization {
  GENERAL_MEDICINE     @map("General Medicine")
  CARDIOLOGY          @map("Cardiology")
  NEUROLOGY           @map("Neurology")
  ORTHOPEDICS         @map("Orthopedics")
  PEDIATRICS          @map("Pediatrics")
  GYNECOLOGY          @map("Gynecology")
  DERMATOLOGY         @map("Dermatology")
  PSYCHIATRY          @map("Psychiatry")
  RADIOLOGY           @map("Radiology")
  ANESTHESIOLOGY      @map("Anesthesiology")
  EMERGENCY_MEDICINE  @map("Emergency Medicine")
  SURGERY             @map("Surgery")
}

enum DoctorStatus {
  active
  inactive
  on_leave
}

enum AppointmentType {
  consultation
  follow_up
  emergency
  routine_checkup
}

enum AppointmentStatus {
  scheduled
  confirmed
  completed
  cancelled
  no_show
}

enum Ward {
  General
  ICU
  CCU
  Pediatric
  Maternity
  Surgical
  Emergency
}

enum AdmissionType {
  emergency
  planned
  transfer
}

enum AdmissionStatus {
  admitted
  discharged
  transferred
}

enum PaymentMethod {
  cash
  card
  bank_transfer
  insurance
}

enum PaymentStatus {
  pending
  partial
  paid
  overdue
}

enum TestType {
  BLOOD_TEST    @map("Blood Tests")
  URINE_TEST    @map("Urine Tests")
  X_RAY         @map("X-Ray")
  CT_SCAN       @map("CT Scan")
  MRI           @map("MRI")
  ECG           @map("ECG")
  ULTRASOUND    @map("Ultrasound")
  BIOPSY        @map("Biopsy")
}

enum TestUrgency {
  routine
  urgent
  stat
}

enum TestStatus {
  requested
  sample_collected
  processing
  completed
  cancelled
  failed
  on_hold
}

enum LabResultStatus {
  pending
  normal
  abnormal
  critical
  reviewed
}

enum LabResultInterpretation {
  normal
  high
  low
  critical_high
  critical_low
  abnormal
}

// Models
model User {
  id          String     @id @default(uuid())
  fullName    String     @map("full_name") @db.VarChar(255)
  email       String     @unique @db.VarChar(255)
  passwordHash String    @map("password_hash") @db.VarChar(255)
  role        UserRole
  phone       String?    @db.VarChar(20)
  department  String?    @db.VarChar(100)
  employeeId  String?    @unique @map("employee_id") @db.VarChar(50)
  status      UserStatus @default(active)
  lastLogin   DateTime?  @map("last_login")
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  // Relations
  createdTemplates      MedicalTemplate[]       @relation()
  completedTemplates    MedicalTemplateInstance[] @relation("CompletedTemplates")
  modifiedTemplates     MedicalTemplateInstance[] @relation("ModifiedTemplates")
  requestedReports      MedicalReport[]         @relation("RequestedReports")
  generatedReports      MedicalReport[]         @relation("GeneratedReports")
  createdReportTemplates ReportTemplate[]       @relation()

  // Treatment Plan Relations
  createdTreatmentPlans TreatmentPlan[]         @relation("TreatmentPlanCreatedBy")
  updatedTreatmentPlans TreatmentPlan[]         @relation("TreatmentPlanUpdatedBy")
  assignedGoals         TreatmentGoal[]         @relation("TreatmentGoalAssignedTo")
  createdGoals          TreatmentGoal[]         @relation("TreatmentGoalCreatedBy")
  assignedTasks         TreatmentTask[]         @relation("TreatmentTaskAssignedTo")
  createdTasks          TreatmentTask[]         @relation("TreatmentTaskCreatedBy")
  recordedProgress      TreatmentProgress[]     @relation("TreatmentProgressRecordedBy")
  conductedReviews      TreatmentReview[]       @relation("TreatmentReviewReviewedBy")

  // Permissions & Groups Relations
  userRoles             UserRole_New[]
  userGroups            UserGroup[]

  @@index([email])
  @@index([employeeId])
  @@index([role])
  @@map("users")
}

model Patient {
  id               String        @id @default(uuid())
  patientId        String        @unique @map("patient_id") @db.VarChar(20)
  firstName        String        @map("first_name") @db.VarChar(100)
  lastName         String        @map("last_name") @db.VarChar(100)
  dateOfBirth      DateTime      @map("date_of_birth") @db.Date
  gender           Gender
  phone            String        @db.VarChar(20)
  address          String?       @db.Text
  emergencyContact String?       @map("emergency_contact") @db.VarChar(20)
  bloodGroup       BloodGroup?   @map("blood_group")
  medicalHistory   String?       @map("medical_history") @db.Text
  allergyNotes     String?       @map("allergy_notes") @db.Text
  status           PatientStatus @default(active)
  createdAt        DateTime      @default(now()) @map("created_at")
  updatedAt        DateTime      @updatedAt @map("updated_at")

  // Relations
  appointments    Appointment[]
  admissions      Admission[]
  bills           Bill[]
  labTests        LabTest[]
  medicalRecords  MedicalRecord[]
  vitalSigns      VitalSign[]
  treatments      Treatment[]
  medicalDocuments MedicalDocument[]
  medicalAlerts   MedicalAlert[]
  allergies       Allergy[]
  immunizations   Immunization[]
  templateInstances MedicalTemplateInstance[]
  treatmentPlans  TreatmentPlan[]

  @@index([patientId])
  @@index([firstName, lastName])
  @@index([phone])
  @@index([status])
  @@map("patients")
}

model Doctor {
  id              String         @id @default(uuid())
  doctorId        String         @unique @map("doctor_id") @db.VarChar(20)
  name            String         @db.VarChar(255)
  specialization  Specialization
  phone           String         @db.VarChar(20)
  email           String         @unique @db.VarChar(255)
  licenseNumber   String         @unique @map("license_number") @db.VarChar(50)
  experienceYears Int            @default(0) @map("experience_years")
  schedule        String?        @db.Text
  consultationFee Decimal        @default(0.00) @map("consultation_fee") @db.Decimal(10, 2)
  status          DoctorStatus   @default(active)
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  // Relations
  appointments   Appointment[]
  admissions     Admission[]
  labTests       LabTest[]
  medicalRecords MedicalRecord[]
  treatmentPlans TreatmentPlan[]

  @@index([doctorId])
  @@index([specialization])
  @@index([status])
  @@map("doctors")
}

model Appointment {
  id              String            @id @default(uuid())
  patientId       String            @map("patient_id")
  doctorId        String            @map("doctor_id")
  appointmentDate DateTime          @map("appointment_date") @db.Date
  appointmentTime DateTime          @map("appointment_time") @db.Time
  duration        Int               @default(30) // in minutes
  type            AppointmentType
  status          AppointmentStatus @default(scheduled)
  notes           String?           @db.Text
  symptoms        String?           @db.Text
  diagnosis       String?           @db.Text
  prescription    String?           @db.Text
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")

  // Relations
  patient        Patient         @relation(fields: [patientId], references: [id])
  doctor         Doctor          @relation(fields: [doctorId], references: [id])
  medicalRecords MedicalRecord[]

  @@index([appointmentDate])
  @@index([status])
  @@map("appointments")
}

model Admission {
  id               String          @id @default(uuid())
  patientId        String          @map("patient_id")
  doctorId         String          @map("doctor_id")
  ward             Ward
  roomNumber       String?         @map("room_number") @db.VarChar(10)
  bedNumber        String?         @map("bed_number") @db.VarChar(10)
  admissionDate    DateTime        @map("admission_date") @db.Date
  dischargeDate    DateTime?       @map("discharge_date") @db.Date
  admissionType    AdmissionType   @map("admission_type")
  reason           String?         @db.Text
  status           AdmissionStatus @default(admitted)
  notes            String?         @db.Text
  dischargeSummary String?         @map("discharge_summary") @db.Text
  createdAt        DateTime        @default(now()) @map("created_at")
  updatedAt        DateTime        @updatedAt @map("updated_at")

  // Relations
  patient Patient @relation(fields: [patientId], references: [id])
  doctor  Doctor  @relation(fields: [doctorId], references: [id])

  @@index([admissionDate])
  @@index([ward])
  @@index([status])
  @@map("admissions")
}

model Bill {
  id            String        @id @default(uuid())
  invoiceNumber String        @unique @map("invoice_number") @db.VarChar(50)
  patientId     String        @map("patient_id")
  totalAmount   Decimal       @map("total_amount") @db.Decimal(10, 2)
  taxAmount     Decimal       @default(0.00) @map("tax_amount") @db.Decimal(10, 2)
  discountAmount Decimal      @default(0.00) @map("discount_amount") @db.Decimal(10, 2)
  paidAmount    Decimal       @default(0.00) @map("paid_amount") @db.Decimal(10, 2)
  paymentMethod PaymentMethod? @map("payment_method")
  paymentStatus PaymentStatus @default(pending) @map("payment_status")
  dueDate       DateTime?     @map("due_date") @db.Date
  notes         String?       @db.Text
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  // Relations
  patient   Patient    @relation(fields: [patientId], references: [id])
  billItems BillItem[]

  @@index([invoiceNumber])
  @@index([paymentStatus])
  @@map("bills")
}

model BillItem {
  id          String  @id @default(uuid())
  billId      String  @map("bill_id")
  description String  @db.VarChar(255)
  quantity    Int     @default(1)
  unitPrice   Decimal @map("unit_price") @db.Decimal(10, 2)
  totalPrice  Decimal @map("total_price") @db.Decimal(10, 2)

  // Relations
  bill Bill @relation(fields: [billId], references: [id])

  @@map("bill_items")
}

model Medicine {
  id              String    @id @default(uuid())
  name            String    @db.VarChar(255)
  category        String    @db.VarChar(100)
  manufacturer    String    @db.VarChar(255)
  batchNumber     String    @map("batch_number") @db.VarChar(50)
  expiryDate      DateTime  @map("expiry_date") @db.Date
  quantity        Int       @default(0)
  unitPrice       Decimal   @map("unit_price") @db.Decimal(10, 2)
  minimumStock    Int       @default(10) @map("minimum_stock")
  description     String?   @db.Text
  sideEffects     String?   @map("side_effects") @db.Text
  dosageInfo      String?   @map("dosage_info") @db.Text
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  prescriptions       Prescription[]
  medicalPrescriptions MedicalPrescription[]

  @@index([name])
  @@index([category])
  @@index([expiryDate])
  @@map("medicines")
}

model Prescription {
  id         String @id @default(uuid())
  medicineId String @map("medicine_id")
  dosage     String @db.VarChar(100)
  frequency  String @db.VarChar(100)
  duration   String @db.VarChar(100)
  quantity   Int
  notes      String? @db.Text

  // Relations
  medicine Medicine @relation(fields: [medicineId], references: [id])

  @@map("prescriptions")
}

model LabTest {
  id           String      @id @default(uuid())
  testNumber   String      @unique @map("test_number") @db.VarChar(50)
  patientId    String      @map("patient_id")
  doctorId     String      @map("doctor_id")
  testType     TestType    @map("test_type")
  urgency      TestUrgency @default(routine)
  status       TestStatus  @default(requested)
  sampleInfo   String?     @map("sample_info") @db.Text
  results      String?     @db.Text
  normalRanges String?     @map("normal_ranges") @db.Text
  technician   String?     @db.VarChar(255)
  cost         Decimal?    @db.Decimal(10, 2)
  requestedAt  DateTime    @default(now()) @map("requested_at")
  collectedAt  DateTime?   @map("collected_at")
  completedAt  DateTime?   @map("completed_at")
  reportUrl    String?     @map("report_url") @db.VarChar(500)
  notes        String?     @db.Text
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")

  // Relations
  patient Patient @relation(fields: [patientId], references: [id])
  doctor  Doctor  @relation(fields: [doctorId], references: [id])
  labResults LabResult[]
  labPanels  LabTestPanel[]

  @@index([testNumber])
  @@index([testType])
  @@index([status])
  @@index([urgency])
  @@map("lab_tests")
}

// Lab Panels for grouping related tests
model LabPanel {
  id              String        @id @default(uuid())
  name            String        @db.VarChar(255)
  description     String?       @db.Text
  category        String        @db.VarChar(100)
  isActive        Boolean       @default(true) @map("is_active")
  cost            Decimal?      @db.Decimal(10, 2)
  turnaroundTime  Int?          @map("turnaround_time") // in hours
  instructions    String?       @db.Text
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations
  testPanels      LabTestPanel[]
  panelTests      LabPanelTest[]

  @@index([category])
  @@index([isActive])
  @@map("lab_panels")
}

// Junction table for tests and panels
model LabTestPanel {
  id        String   @id @default(uuid())
  labTestId String   @map("lab_test_id")
  panelId   String   @map("panel_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  labTest LabTest  @relation(fields: [labTestId], references: [id])
  panel   LabPanel @relation(fields: [panelId], references: [id])

  @@unique([labTestId, panelId])
  @@map("lab_test_panels")
}

// Individual lab parameters that can be part of panels
model LabParameter {
  id              String   @id @default(uuid())
  code            String   @unique @db.VarChar(20)
  name            String   @db.VarChar(255)
  description     String?  @db.Text
  unit            String   @db.VarChar(50)
  normalRangeMin  Decimal? @map("normal_range_min") @db.Decimal(10, 4)
  normalRangeMax  Decimal? @map("normal_range_max") @db.Decimal(10, 4)
  criticalMin     Decimal? @map("critical_min") @db.Decimal(10, 4)
  criticalMax     Decimal? @map("critical_max") @db.Decimal(10, 4)
  category        String   @db.VarChar(100)
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  panelTests LabPanelTest[]
  results    LabResult[]

  @@index([code])
  @@index([category])
  @@index([isActive])
  @@map("lab_parameters")
}

// Junction table for panels and parameters
model LabPanelTest {
  id          String   @id @default(uuid())
  panelId     String   @map("panel_id")
  parameterId String   @map("parameter_id")
  isRequired  Boolean  @default(true) @map("is_required")
  displayOrder Int?    @map("display_order")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  panel     LabPanel     @relation(fields: [panelId], references: [id])
  parameter LabParameter @relation(fields: [parameterId], references: [id])

  @@unique([panelId, parameterId])
  @@map("lab_panel_tests")
}

// Individual lab result values
model LabResult {
  id               String                  @id @default(uuid())
  labTestId        String                  @map("lab_test_id")
  parameterId      String                  @map("parameter_id")
  value            String                  @db.VarChar(255)
  numericValue     Decimal?                @map("numeric_value") @db.Decimal(15, 6)
  unit             String                  @db.VarChar(50)
  referenceRange   String?                 @map("reference_range") @db.VarChar(100)
  status           LabResultStatus         @default(pending)
  interpretation   LabResultInterpretation @default(normal)
  flags            String?                 @db.VarChar(100) // H, L, HH, LL, etc.
  notes            String?                 @db.Text
  verifiedBy       String?                 @map("verified_by") @db.VarChar(255)
  verifiedAt       DateTime?               @map("verified_at")
  isAbnormal       Boolean                 @default(false) @map("is_abnormal")
  isCritical       Boolean                 @default(false) @map("is_critical")
  createdAt        DateTime                @default(now()) @map("created_at")
  updatedAt        DateTime                @updatedAt @map("updated_at")

  // Relations
  labTest   LabTest      @relation(fields: [labTestId], references: [id])
  parameter LabParameter @relation(fields: [parameterId], references: [id])

  @@index([labTestId])
  @@index([parameterId])
  @@index([status])
  @@index([interpretation])
  @@index([isAbnormal])
  @@index([isCritical])
  @@map("lab_results")
}

// Reference ranges by demographics
model LabReferenceRange {
  id              String   @id @default(uuid())
  parameterId     String   @map("parameter_id")
  gender          Gender?
  ageMin          Int?     @map("age_min")
  ageMax          Int?     @map("age_max")
  normalMin       Decimal  @map("normal_min") @db.Decimal(10, 4)
  normalMax       Decimal  @map("normal_max") @db.Decimal(10, 4)
  criticalMin     Decimal? @map("critical_min") @db.Decimal(10, 4)
  criticalMax     Decimal? @map("critical_max") @db.Decimal(10, 4)
  unit            String   @db.VarChar(50)
  condition       String?  @db.VarChar(255) // pregnancy, etc.
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@index([parameterId])
  @@index([gender])
  @@index([ageMin, ageMax])
  @@map("lab_reference_ranges")
}

// EMR-specific enums
enum MedicalRecordType {
  VISIT_NOTE
  CONSULTATION
  DISCHARGE_SUMMARY
  PROGRESS_NOTE
  OPERATIVE_REPORT
  DIAGNOSTIC_REPORT
}

enum DiagnosisType {
  PRIMARY
  SECONDARY
  DIFFERENTIAL
  PROVISIONAL
  FINAL
}

enum VitalSignType {
  BLOOD_PRESSURE
  HEART_RATE
  TEMPERATURE
  RESPIRATORY_RATE
  OXYGEN_SATURATION
  WEIGHT
  HEIGHT
  BMI
  PAIN_SCALE
}

enum DocumentType {
  PRESCRIPTION
  LAB_REPORT
  RADIOLOGY_REPORT
  INSURANCE_DOCUMENT
  CONSENT_FORM
  MEDICAL_CERTIFICATE
  OTHER
}

enum TreatmentStatus {
  ACTIVE
  COMPLETED
  DISCONTINUED
  ON_HOLD
}

enum AlertSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ImmunizationStatus {
  SCHEDULED
  ADMINISTERED
  OVERDUE
  CONTRAINDICATED
}

enum MedicalTemplateCategory {
  VISIT_NOTES
  REPORTS
  FORMS
  ASSESSMENTS
  DISCHARGE_SUMMARIES
  OPERATIVE_NOTES
  CONSULTATION_NOTES
  PROGRESS_NOTES
  CUSTOM
}

enum MedicalTemplateType {
  STRUCTURED_FORM
  FREE_TEXT
  CHECKLIST
  QUESTIONNAIRE
  CLINICAL_PATHWAY
}

enum TemplateInstanceStatus {
  DRAFT
  IN_PROGRESS
  COMPLETED
  REVIEWED
  SIGNED
  ARCHIVED
}

// EMR Core Models
model MedicalRecord {
  id              String            @id @default(uuid())
  patientId       String            @map("patient_id")
  doctorId        String            @map("doctor_id")
  appointmentId   String?           @map("appointment_id")
  recordType      MedicalRecordType @map("record_type")
  title           String            @db.VarChar(255)
  chiefComplaint  String?           @map("chief_complaint") @db.Text
  historyPresent  String?           @map("history_present") @db.Text
  reviewSystems   String?           @map("review_systems") @db.Text
  physicalExam    String?           @map("physical_exam") @db.Text
  assessment      String?           @db.Text
  plan            String?           @db.Text
  followUpInstructions String?      @map("follow_up_instructions") @db.Text
  isActive        Boolean           @default(true) @map("is_active")
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")

  // Relations
  patient     Patient      @relation(fields: [patientId], references: [id])
  doctor      Doctor       @relation(fields: [doctorId], references: [id])
  appointment Appointment? @relation(fields: [appointmentId], references: [id])
  diagnoses   Diagnosis[]
  vitalSigns  VitalSign[]
  prescriptions MedicalPrescription[]
  documents   MedicalDocument[]
  templateInstances MedicalTemplateInstance[]

  @@index([patientId])
  @@index([doctorId])
  @@index([recordType])
  @@index([createdAt])
  @@map("medical_records")
}

model Diagnosis {
  id              String        @id @default(uuid())
  medicalRecordId String        @map("medical_record_id")
  icd10Code       String?       @map("icd10_code") @db.VarChar(20)
  description     String        @db.VarChar(500)
  type            DiagnosisType
  notes           String?       @db.Text
  diagnosedAt     DateTime      @default(now()) @map("diagnosed_at")
  resolvedAt      DateTime?     @map("resolved_at")
  isActive        Boolean       @default(true) @map("is_active")
  severity        String?       @db.VarChar(50)
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations
  medicalRecord MedicalRecord @relation(fields: [medicalRecordId], references: [id])
  treatments    Treatment[]

  @@index([medicalRecordId])
  @@index([icd10Code])
  @@index([type])
  @@map("diagnoses")
}

model VitalSign {
  id              String        @id @default(uuid())
  patientId       String        @map("patient_id")
  medicalRecordId String?       @map("medical_record_id")
  type            VitalSignType
  value           String        @db.VarChar(50)
  unit            String        @db.VarChar(20)
  normalRange     String?       @map("normal_range") @db.VarChar(100)
  isAbnormal      Boolean       @default(false) @map("is_abnormal")
  notes           String?       @db.Text
  measuredBy      String?       @map("measured_by") @db.VarChar(255)
  measuredAt      DateTime      @default(now()) @map("measured_at")
  createdAt       DateTime      @default(now()) @map("created_at")

  // Relations
  patient       Patient        @relation(fields: [patientId], references: [id])
  medicalRecord MedicalRecord? @relation(fields: [medicalRecordId], references: [id])

  @@index([patientId])
  @@index([type])
  @@index([measuredAt])
  @@map("vital_signs")
}

model MedicalPrescription {
  id              String  @id @default(uuid())
  medicalRecordId String  @map("medical_record_id")
  medicineId      String  @map("medicine_id")
  dosage          String  @db.VarChar(100)
  frequency       String  @db.VarChar(100)
  duration        String  @db.VarChar(100)
  quantity        Int
  refills         Int     @default(0)
  instructions    String? @db.Text
  warnings        String? @db.Text
  isActive        Boolean @default(true) @map("is_active")
  prescribedAt    DateTime @default(now()) @map("prescribed_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  medicalRecord MedicalRecord @relation(fields: [medicalRecordId], references: [id])
  medicine      Medicine     @relation(fields: [medicineId], references: [id])

  @@index([medicalRecordId])
  @@index([medicineId])
  @@map("medical_prescriptions")
}

model Treatment {
  id          String          @id @default(uuid())
  patientId   String          @map("patient_id")
  diagnosisId String          @map("diagnosis_id")
  name        String          @db.VarChar(255)
  description String?         @db.Text
  startDate   DateTime        @map("start_date")
  endDate     DateTime?       @map("end_date")
  status      TreatmentStatus @default(ACTIVE)
  instructions String?        @db.Text
  notes       String?         @db.Text
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  // Relations
  patient   Patient   @relation(fields: [patientId], references: [id])
  diagnosis Diagnosis @relation(fields: [diagnosisId], references: [id])

  @@index([patientId])
  @@index([diagnosisId])
  @@index([status])
  @@map("treatments")
}

model MedicalDocument {
  id              String       @id @default(uuid())
  patientId       String       @map("patient_id")
  medicalRecordId String?      @map("medical_record_id")
  type            DocumentType
  title           String       @db.VarChar(255)
  description     String?      @db.Text
  filePath        String       @map("file_path") @db.VarChar(500)
  fileName        String       @map("file_name") @db.VarChar(255)
  fileSize        Int          @map("file_size")
  mimeType        String       @map("mime_type") @db.VarChar(100)
  uploadedBy      String       @map("uploaded_by") @db.VarChar(255)
  isActive        Boolean      @default(true) @map("is_active")
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")

  // Relations
  patient       Patient        @relation(fields: [patientId], references: [id])
  medicalRecord MedicalRecord? @relation(fields: [medicalRecordId], references: [id])

  @@index([patientId])
  @@index([type])
  @@index([createdAt])
  @@map("medical_documents")
}

model MedicalAlert {
  id          String        @id @default(uuid())
  patientId   String        @map("patient_id")
  alertType   String        @map("alert_type") @db.VarChar(100)
  title       String        @db.VarChar(255)
  message     String        @db.Text
  severity    AlertSeverity
  isActive    Boolean       @default(true) @map("is_active")
  triggeredAt DateTime      @default(now()) @map("triggered_at")
  acknowledgedAt DateTime?  @map("acknowledged_at")
  acknowledgedBy String?    @map("acknowledged_by") @db.VarChar(255)
  expiresAt   DateTime?     @map("expires_at")
  createdAt   DateTime      @default(now()) @map("created_at")

  // Relations
  patient Patient @relation(fields: [patientId], references: [id])

  @@index([patientId])
  @@index([severity])
  @@index([isActive])
  @@map("medical_alerts")
}

model Allergy {
  id          String   @id @default(uuid())
  patientId   String   @map("patient_id")
  allergen    String   @db.VarChar(255)
  category    String   @db.VarChar(100)
  reaction    String   @db.Text
  severity    String   @db.VarChar(50)
  notes       String?  @db.Text
  diagnosedAt DateTime @default(now()) @map("diagnosed_at")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  patient Patient @relation(fields: [patientId], references: [id])

  @@index([patientId])
  @@index([category])
  @@index([severity])
  @@map("allergies")
}

model Immunization {
  id               String             @id @default(uuid())
  patientId        String             @map("patient_id")
  vaccineName      String             @map("vaccine_name") @db.VarChar(255)
  brandName        String?            @map("brand_name") @db.VarChar(255)
  lotNumber        String?            @map("lot_number") @db.VarChar(50)
  doseNumber       Int                @map("dose_number")
  totalDoses       Int?               @map("total_doses")
  administeredDate DateTime?          @map("administered_date")
  scheduledDate    DateTime           @map("scheduled_date")
  status           ImmunizationStatus @default(SCHEDULED)
  administeredBy   String?            @map("administered_by") @db.VarChar(255)
  site             String?            @db.VarChar(100)
  route            String?            @db.VarChar(100)
  notes            String?            @db.Text
  reactions        String?            @db.Text
  createdAt        DateTime           @default(now()) @map("created_at")
  updatedAt        DateTime           @updatedAt @map("updated_at")

  // Relations
  patient Patient @relation(fields: [patientId], references: [id])

  @@index([patientId])
  @@index([vaccineName])
  @@index([status])
  @@index([scheduledDate])
  @@map("immunizations")
}

// Medical template system for standardized notes and reports
model MedicalTemplate {
  id                String                @id @default(uuid())
  name              String                @db.VarChar(200)
  description       String?               @db.Text
  category          MedicalTemplateCategory
  templateType      MedicalTemplateType
  content           Json                  // Template structure with fields
  isActive          Boolean               @default(true) @map("is_active")
  isSystem          Boolean               @default(false) @map("is_system") // System vs user-created
  createdBy         String?               @map("created_by")
  departmentId      String?               @map("department_id")
  specialization    String?               @db.VarChar(100)
  createdAt         DateTime              @default(now()) @map("created_at")
  updatedAt         DateTime              @updatedAt @map("updated_at")

  // Relations
  templateInstances MedicalTemplateInstance[]
  createdByUser     User?                 @relation(fields: [createdBy], references: [id])

  @@index([category])
  @@index([templateType])
  @@index([isActive])
  @@index([createdBy])
  @@index([specialization])
  @@map("medical_templates")
}

// Instances of templates filled out for specific patients
model MedicalTemplateInstance {
  id               String          @id @default(uuid())
  templateId       String          @map("template_id")
  patientId        String          @map("patient_id")
  medicalRecordId  String?         @map("medical_record_id")
  filledData       Json            // Filled template data
  completedBy      String          @map("completed_by")
  completedAt      DateTime        @default(now()) @map("completed_at")
  lastModifiedBy   String?         @map("last_modified_by")
  lastModifiedAt   DateTime?       @map("last_modified_at")
  status           TemplateInstanceStatus @default(DRAFT)
  notes            String?         @db.Text
  createdAt        DateTime        @default(now()) @map("created_at")
  updatedAt        DateTime        @updatedAt @map("updated_at")

  // Relations
  template         MedicalTemplate @relation(fields: [templateId], references: [id])
  patient          Patient         @relation(fields: [patientId], references: [id])
  medicalRecord    MedicalRecord?  @relation(fields: [medicalRecordId], references: [id])
  completedByUser  User            @relation("CompletedTemplates", fields: [completedBy], references: [id])
  lastModifiedByUser User?         @relation("ModifiedTemplates", fields: [lastModifiedBy], references: [id])

  @@index([templateId])
  @@index([patientId])
  @@index([medicalRecordId])
  @@index([completedBy])
  @@index([status])
  @@index([completedAt])
  @@map("medical_template_instances")
}

// Audit log for tracking all system activities
model AuditLog {
  id        String   @id @default(uuid())
  userId    String?  @map("user_id")
  action    String   @db.VarChar(100)
  entity    String   @db.VarChar(100)
  entityId  String   @map("entity_id")
  oldData   Json?    @map("old_data")
  newData   Json?    @map("new_data")
  ipAddress String?  @map("ip_address") @db.VarChar(45)
  userAgent String?  @map("user_agent") @db.Text
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([action])
  @@index([entity])
  @@index([createdAt])
  @@map("audit_logs")
}

enum ReportType {
  PATIENT_SUMMARY
  MEDICAL_HISTORY
  PRESCRIPTION_REPORT
  VITAL_SIGNS_REPORT
  LAB_RESULTS_REPORT
  ADMISSION_REPORT
  FINANCIAL_REPORT
  APPOINTMENT_REPORT
  DIAGNOSIS_REPORT
  CUSTOM_REPORT
}

enum ReportStatus {
  PENDING
  GENERATING
  COMPLETED
  FAILED
  CANCELLED
}

enum ReportFormat {
  PDF
  CSV
  EXCEL
  JSON
}

// Medical Reports
model MedicalReport {
  id              String       @id @default(uuid())
  title           String       @db.VarChar(255)
  description     String?      @db.Text
  type            ReportType
  format          ReportFormat @default(PDF)
  status          ReportStatus @default(PENDING)

  // Report parameters and filters
  parameters      Json?        // Flexible JSON to store report parameters
  filters         Json?        // Date ranges, patient filters, etc.

  // File information
  filePath        String?      @map("file_path") @db.VarChar(500)
  fileName        String?      @map("file_name") @db.VarChar(255)
  fileSize        Int?         @map("file_size")

  // User information
  requestedBy     String       @map("requested_by")
  generatedBy     String?      @map("generated_by")

  // Timestamps
  requestedAt     DateTime     @default(now()) @map("requested_at")
  startedAt       DateTime?    @map("started_at")
  completedAt     DateTime?    @map("completed_at")
  expiresAt       DateTime?    @map("expires_at")

  // Error handling
  errorMessage    String?      @map("error_message") @db.Text
  retryCount      Int          @default(0) @map("retry_count")

  // Metadata
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")

  // Relations
  requestedByUser User         @relation("RequestedReports", fields: [requestedBy], references: [id])
  generatedByUser User?        @relation("GeneratedReports", fields: [generatedBy], references: [id])

  @@index([type])
  @@index([status])
  @@index([requestedBy])
  @@index([requestedAt])
  @@index([expiresAt])
  @@map("medical_reports")
}

// Report Templates for standardized reports
model ReportTemplate {
  id              String       @id @default(uuid())
  name            String       @db.VarChar(255)
  description     String?      @db.Text
  type            ReportType
  defaultFormat   ReportFormat @default(PDF)

  // Template configuration
  templateConfig  Json         // Report structure, fields, formatting
  defaultParams   Json?        // Default parameters

  // Access control
  isPublic        Boolean      @default(false) @map("is_public")
  createdBy       String       @map("created_by")

  // Status
  isActive        Boolean      @default(true) @map("is_active")

  // Metadata
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")

  // Relations
  createdByUser   User         @relation(fields: [createdBy], references: [id])

  @@index([type])
  @@index([isPublic])
  @@index([isActive])
  @@index([createdBy])
  @@map("report_templates")
}

// Treatment Plan Management System
enum TreatmentPlanStatus {
  ACTIVE
  COMPLETED
  PAUSED
  CANCELLED
  DRAFT
}

enum TreatmentGoalStatus {
  NOT_STARTED
  IN_PROGRESS
  ACHIEVED
  PARTIALLY_ACHIEVED
  NOT_ACHIEVED
  DISCONTINUED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  OVERDUE
  CANCELLED
}

model TreatmentPlan {
  id              String               @id @default(uuid())

  // Basic information
  title           String               @db.VarChar(255)
  description     String?              @db.Text
  diagnosis       String               @db.VarChar(500)

  // Dates
  startDate       DateTime             @map("start_date")
  endDate         DateTime?            @map("end_date")
  reviewDate      DateTime?            @map("review_date")

  // Status and priority
  status          TreatmentPlanStatus  @default(ACTIVE)
  priority        TaskPriority         @default(MEDIUM)

  // Progress tracking
  overallProgress Int                  @default(0) @map("overall_progress") // 0-100%

  // Notes and observations
  notes           String?              @db.Text
  objectives      Json?                // Array of treatment objectives

  // Relations
  patientId       String               @map("patient_id")
  doctorId        String               @map("doctor_id")
  createdBy       String               @map("created_by")
  updatedBy       String?              @map("updated_by")

  // Metadata
  isActive        Boolean              @default(true) @map("is_active")
  createdAt       DateTime             @default(now()) @map("created_at")
  updatedAt       DateTime             @updatedAt @map("updated_at")

  // Relations
  patient         Patient              @relation(fields: [patientId], references: [id])
  doctor          Doctor               @relation(fields: [doctorId], references: [id])
  createdByUser   User                 @relation("TreatmentPlanCreatedBy", fields: [createdBy], references: [id])
  updatedByUser   User?                @relation("TreatmentPlanUpdatedBy", fields: [updatedBy], references: [id])

  // Child relations
  goals           TreatmentGoal[]
  tasks           TreatmentTask[]
  progress        TreatmentProgress[]
  reviews         TreatmentReview[]

  @@index([patientId])
  @@index([doctorId])
  @@index([status])
  @@index([startDate])
  @@index([isActive])
  @@map("treatment_plans")
}

model TreatmentGoal {
  id              String               @id @default(uuid())

  // Goal details
  title           String               @db.VarChar(255)
  description     String?              @db.Text
  targetValue     String?              @map("target_value") @db.VarChar(255)
  currentValue    String?              @map("current_value") @db.VarChar(255)
  unit            String?              @db.VarChar(50)

  // Dates
  targetDate      DateTime?            @map("target_date")
  achievedDate    DateTime?            @map("achieved_date")

  // Status and progress
  status          TreatmentGoalStatus  @default(NOT_STARTED)
  progress        Int                  @default(0) // 0-100%
  priority        TaskPriority         @default(MEDIUM)

  // Notes
  notes           String?              @db.Text

  // Relations
  treatmentPlanId String               @map("treatment_plan_id")
  assignedTo      String?              @map("assigned_to")
  createdBy       String               @map("created_by")

  // Metadata
  isActive        Boolean              @default(true) @map("is_active")
  createdAt       DateTime             @default(now()) @map("created_at")
  updatedAt       DateTime             @updatedAt @map("updated_at")

  // Relations
  treatmentPlan   TreatmentPlan        @relation(fields: [treatmentPlanId], references: [id], onDelete: Cascade)
  assignedToUser  User?                @relation("TreatmentGoalAssignedTo", fields: [assignedTo], references: [id])
  createdByUser   User                 @relation("TreatmentGoalCreatedBy", fields: [createdBy], references: [id])

  // Child relations
  tasks           TreatmentTask[]
  progressEntries TreatmentProgress[]

  @@index([treatmentPlanId])
  @@index([status])
  @@index([targetDate])
  @@index([isActive])
  @@map("treatment_goals")
}

model TreatmentTask {
  id              String               @id @default(uuid())

  // Task details
  title           String               @db.VarChar(255)
  description     String?              @db.Text
  instructions    String?              @db.Text

  // Scheduling
  dueDate         DateTime?            @map("due_date")
  completedAt     DateTime?            @map("completed_at")
  estimatedDuration Int?               @map("estimated_duration") // in minutes

  // Status and priority
  status          TaskStatus           @default(PENDING)
  priority        TaskPriority         @default(MEDIUM)

  // Task type and category
  taskType        String               @map("task_type") @db.VarChar(100) // medication, exercise, appointment, test, etc.
  category        String?              @db.VarChar(100) // physical_therapy, medication_management, lifestyle, etc.

  // Progress and completion
  progress        Int                  @default(0) // 0-100%
  completionNotes String?              @map("completion_notes") @db.Text

  // Recurrence (for recurring tasks)
  isRecurring     Boolean              @default(false) @map("is_recurring")
  recurrencePattern Json?              @map("recurrence_pattern") // frequency, interval, days, etc.

  // Relations
  treatmentPlanId String               @map("treatment_plan_id")
  goalId          String?              @map("goal_id")
  assignedTo      String?              @map("assigned_to")
  createdBy       String               @map("created_by")

  // Metadata
  isActive        Boolean              @default(true) @map("is_active")
  createdAt       DateTime             @default(now()) @map("created_at")
  updatedAt       DateTime             @updatedAt @map("updated_at")

  // Relations
  treatmentPlan   TreatmentPlan        @relation(fields: [treatmentPlanId], references: [id], onDelete: Cascade)
  goal            TreatmentGoal?       @relation(fields: [goalId], references: [id])
  assignedToUser  User?                @relation("TreatmentTaskAssignedTo", fields: [assignedTo], references: [id])
  createdByUser   User                 @relation("TreatmentTaskCreatedBy", fields: [createdBy], references: [id])

  // Child relations
  progressEntries TreatmentProgress[]

  @@index([treatmentPlanId])
  @@index([goalId])
  @@index([status])
  @@index([dueDate])
  @@index([taskType])
  @@index([isActive])
  @@map("treatment_tasks")
}

model TreatmentProgress {
  id              String               @id @default(uuid())

  // Progress details
  date            DateTime
  progressType    String               @map("progress_type") @db.VarChar(100) // goal_progress, task_completion, assessment, etc.
  value           String?              @db.VarChar(255) // numeric value, status, or measurement
  unit            String?              @db.VarChar(50)

  // Notes and observations
  notes           String?              @db.Text
  observations    String?              @db.Text

  // Attachments
  attachments     Json?                // Array of file references

  // Relations
  treatmentPlanId String               @map("treatment_plan_id")
  goalId          String?              @map("goal_id")
  taskId          String?              @map("task_id")
  recordedBy      String               @map("recorded_by")

  // Metadata
  createdAt       DateTime             @default(now()) @map("created_at")
  updatedAt       DateTime             @updatedAt @map("updated_at")

  // Relations
  treatmentPlan   TreatmentPlan        @relation(fields: [treatmentPlanId], references: [id], onDelete: Cascade)
  goal            TreatmentGoal?       @relation(fields: [goalId], references: [id])
  task            TreatmentTask?       @relation(fields: [taskId], references: [id])
  recordedByUser  User                 @relation("TreatmentProgressRecordedBy", fields: [recordedBy], references: [id])

  @@index([treatmentPlanId])
  @@index([goalId])
  @@index([taskId])
  @@index([date])
  @@index([progressType])
  @@map("treatment_progress")
}

model TreatmentReview {
  id              String               @id @default(uuid())

  // Review details
  reviewDate      DateTime             @map("review_date")
  reviewType      String               @map("review_type") @db.VarChar(100) // scheduled, emergency, discharge, etc.

  // Assessment
  overallAssessment String?            @map("overall_assessment") @db.Text
  progressSummary String?              @map("progress_summary") @db.Text
  goalsAssessment Json?                @map("goals_assessment") // Assessment of each goal

  // Recommendations
  recommendations String?              @db.Text
  adjustments     String?              @db.Text
  nextSteps       String?              @map("next_steps") @db.Text

  // Next review
  nextReviewDate  DateTime?            @map("next_review_date")

  // Status changes
  statusBefore    TreatmentPlanStatus? @map("status_before")
  statusAfter     TreatmentPlanStatus? @map("status_after")

  // Relations
  treatmentPlanId String               @map("treatment_plan_id")
  reviewedBy      String               @map("reviewed_by")

  // Metadata
  createdAt       DateTime             @default(now()) @map("created_at")
  updatedAt       DateTime             @updatedAt @map("updated_at")

  // Relations
  treatmentPlan   TreatmentPlan        @relation(fields: [treatmentPlanId], references: [id], onDelete: Cascade)
  reviewedByUser  User                 @relation("TreatmentReviewReviewedBy", fields: [reviewedBy], references: [id])

  @@index([treatmentPlanId])
  @@index([reviewDate])
  @@index([reviewType])
  @@map("treatment_reviews")
}

// System Settings
enum SettingType {
  SYSTEM
  USER
  HOSPITAL
}

model Setting {
  id        String      @id @default(uuid())
  type      SettingType
  category  String      @db.VarChar(100) // profile, hospital, appearance, notification, etc.
  key       String      @db.VarChar(255)
  value     Json        // Flexible JSON value
  userId    String?     @map("user_id") // For user-specific settings
  isPublic  Boolean     @default(false) @map("is_public")
  createdAt DateTime    @default(now()) @map("created_at")
  updatedAt DateTime    @updatedAt @map("updated_at")

  @@unique([type, category, key, userId])
  @@index([type])
  @@index([category])
  @@index([userId])
  @@map("settings")
}

// Permissions & Groups System
enum PermissionAction {
  CREATE
  READ
  UPDATE
  DELETE
  EXECUTE
}

enum ResourceType {
  PATIENT
  DOCTOR
  APPOINTMENT
  MEDICAL_RECORD
  PRESCRIPTION
  LAB_TEST
  BILLING
  ADMISSION
  USER
  SETTINGS
  REPORTS
  PHARMACY
  ALL
}

model Permission {
  id          String           @id @default(uuid())
  name        String           @unique @db.VarChar(100)
  description String?          @db.Text
  resource    ResourceType
  action      PermissionAction
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")

  // Relations
  roles       RolePermission[]
  groups      GroupPermission[]

  @@unique([resource, action])
  @@index([resource])
  @@index([action])
  @@map("permissions")
}

model Role {
  id          String     @id @default(uuid())
  name        String     @unique @db.VarChar(100)
  description String?    @db.Text
  isSystem    Boolean    @default(false) @map("is_system") // System roles can't be deleted
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  // Relations
  permissions RolePermission[]
  userRoles   UserRole_New[]

  @@index([name])
  @@map("roles")
}

model RolePermission {
  id           String     @id @default(uuid())
  roleId       String     @map("role_id")
  permissionId String     @map("permission_id")
  createdAt    DateTime   @default(now()) @map("created_at")

  // Relations
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@map("role_permissions")
}

model Group {
  id          String    @id @default(uuid())
  name        String    @unique @db.VarChar(100)
  description String?   @db.Text
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  users       UserGroup[]
  permissions GroupPermission[]

  @@index([name])
  @@map("groups")
}

model GroupPermission {
  id           String     @id @default(uuid())
  groupId      String     @map("group_id")
  permissionId String     @map("permission_id")
  createdAt    DateTime   @default(now()) @map("created_at")

  // Relations
  group        Group      @relation(fields: [groupId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([groupId, permissionId])
  @@index([groupId])
  @@index([permissionId])
  @@map("group_permissions")
}

model UserRole_New {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  roleId    String   @map("role_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_roles")
}

model UserGroup {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  groupId   String   @map("group_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([userId, groupId])
  @@index([userId])
  @@index([groupId])
  @@map("user_groups")
}